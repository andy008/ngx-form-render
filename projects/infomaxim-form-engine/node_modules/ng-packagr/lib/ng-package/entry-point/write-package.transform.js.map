{"version":3,"file":"write-package.transform.js","sourceRoot":"","sources":["../../../../src/lib/ng-package/entry-point/write-package.transform.ts"],"names":[],"mappings":"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","sourcesContent":["import * as path from 'path';\nimport * as ora from 'ora';\nimport { Transform, transformFromPromise } from '../../graph/transform';\nimport { colors } from '../../utils/color';\nimport { NgEntryPoint } from './entry-point';\nimport { NgPackage } from '../package';\nimport { ensureUnixPath } from '../../utils/path';\nimport { copyFile, exists, stat, rimraf, writeFile } from '../../utils/fs';\nimport * as log from '../../utils/log';\nimport { globFiles } from '../../utils/glob';\nimport { EntryPointNode, isEntryPointInProgress, isPackage, PackageNode, fileUrl } from '../nodes';\nimport { Node } from '../../graph/node';\n\nexport const writePackageTransform: Transform = transformFromPromise(async graph => {\n  const spinner = ora({\n    hideCursor: false,\n    discardStdin: false,\n  });\n  const entryPoint: EntryPointNode = graph.find(isEntryPointInProgress());\n  const ngEntryPoint: NgEntryPoint = entryPoint.data.entryPoint;\n  const ngPackageNode: PackageNode = graph.find(isPackage);\n  const ngPackage = ngPackageNode.data;\n  const { destinationFiles } = entryPoint.data;\n  const ignorePaths: string[] = [\n    '.gitkeep',\n    '**/.DS_Store',\n    '**/Thumbs.db',\n    '**/node_modules/**',\n    `${ngPackage.dest}/**`,\n  ];\n\n  if (ngPackage.assets.length && !ngEntryPoint.isSecondaryEntryPoint) {\n    const assetFiles: string[] = [];\n\n    // COPY ASSET FILES TO DESTINATION\n    spinner.start('Copying assets');\n\n    try {\n      for (let asset of ngPackage.assets) {\n        asset = path.join(ngPackage.src, asset);\n\n        if (await exists(asset)) {\n          const stats = await stat(asset);\n          if (stats.isFile()) {\n            assetFiles.push(asset);\n            continue;\n          }\n\n          if (stats.isDirectory()) {\n            asset = path.join(asset, '**/*');\n          }\n        }\n\n        const files = await globFiles(asset, {\n          ignore: ignorePaths,\n          cache: ngPackageNode.cache.globCache,\n          dot: true,\n          nodir: true,\n        });\n\n        if (files.length) {\n          assetFiles.push(...files);\n        }\n      }\n\n      for (const file of assetFiles) {\n        const relativePath = path.relative(ngPackage.src, file);\n        const destination = path.resolve(ngPackage.dest, relativePath);\n        const nodeUri = fileUrl(ensureUnixPath(file));\n        let node = graph.get(nodeUri);\n        if (!node) {\n          node = new Node(nodeUri);\n          graph.put(node);\n        }\n\n        entryPoint.dependsOn(node);\n        await copyFile(file, destination);\n      }\n    } catch (error) {\n      spinner.fail();\n      throw error;\n    }\n    spinner.succeed();\n  }\n\n  // 6. WRITE PACKAGE.JSON\n  try {\n    spinner.start('Writing package metadata');\n    const relativeUnixFromDestPath = (filePath: string) =>\n      ensureUnixPath(path.relative(ngEntryPoint.destinationPath, filePath));\n\n    const isIvy = !!entryPoint.data.tsConfig.options.enableIvy;\n\n    await writePackageJson(\n      ngEntryPoint,\n      ngPackage,\n      {\n        main: relativeUnixFromDestPath(destinationFiles.umd),\n        module: relativeUnixFromDestPath(destinationFiles.fesm2015),\n        es2015: relativeUnixFromDestPath(destinationFiles.fesm2015),\n        esm2015: relativeUnixFromDestPath(destinationFiles.esm2015),\n        fesm2015: relativeUnixFromDestPath(destinationFiles.fesm2015),\n        typings: relativeUnixFromDestPath(destinationFiles.declarations),\n        // Ivy doesn't generate metadata files\n        metadata: isIvy ? undefined : relativeUnixFromDestPath(destinationFiles.metadata),\n        // webpack v4+ specific flag to enable advanced optimizations and code splitting\n        sideEffects: ngEntryPoint.sideEffects,\n      },\n      isIvy,\n      spinner,\n    );\n  } catch (error) {\n    spinner.fail();\n    throw error;\n  }\n  spinner.succeed();\n  spinner.info(`Built ${ngEntryPoint.moduleId}`);\n\n  return graph;\n});\n\n/**\n * Creates and writes a `package.json` file of the entry point used by the `node_module`\n * resolution strategies.\n *\n * #### Example\n *\n * A consumer of the entry point depends on it by `import {..} from '@my/module/id';`.\n * The module id `@my/module/id` will be resolved to the `package.json` file that is written by\n * this build step.\n * The properties `main`, `module`, `typings` (and so on) in the `package.json` point to the\n * flattened JavaScript bundles, type definitions, (...).\n *\n * @param entryPoint An entry point of an Angular package / library\n * @param additionalProperties Additional properties, e.g. binary artefacts (bundle files), to merge into `package.json`\n */\nasync function writePackageJson(\n  entryPoint: NgEntryPoint,\n  pkg: NgPackage,\n  additionalProperties: { [key: string]: string | boolean | string[] },\n  isIvy: boolean,\n  spinner: ora.Ora,\n): Promise<void> {\n  log.debug('Writing package.json');\n\n  // set additional properties\n  const packageJson = { ...entryPoint.packageJson, ...additionalProperties };\n\n  // read tslib version from `@angular/compiler` so that our tslib\n  // version at least matches that of angular if we use require('tslib').version\n  // it will get what installed and not the minimum version nor if it is a `~` or `^`\n  // this is only required for primary\n  if (!entryPoint.isSecondaryEntryPoint) {\n    if (!packageJson.peerDependencies?.tslib && !packageJson.dependencies?.tslib) {\n      const {\n        peerDependencies: angularPeerDependencies = {},\n        dependencies: angularDependencies = {},\n      } = require('@angular/compiler/package.json');\n      const tsLibVersion = angularPeerDependencies.tslib || angularDependencies.tslib;\n\n      if (tsLibVersion) {\n        packageJson.dependencies = {\n          ...packageJson.dependencies,\n          tslib: tsLibVersion,\n        };\n      }\n    } else if (packageJson.peerDependencies?.tslib) {\n      spinner.warn(\n        colors.yellow(\n          `'tslib' is no longer recommended to be used as a 'peerDependencies'. Moving it to 'dependencies'.`,\n        ),\n      );\n      packageJson.dependencies = {\n        ...(packageJson.dependencies || {}),\n        tslib: packageJson.peerDependencies.tslib,\n      };\n\n      delete packageJson.peerDependencies.tslib;\n    }\n  }\n\n  // Verify non-peerDependencies as they can easily lead to duplicate installs or version conflicts\n  // in the node_modules folder of an application\n  const allowedList = pkg.allowedNonPeerDependencies.map(value => new RegExp(value));\n  try {\n    checkNonPeerDependencies(packageJson, 'dependencies', allowedList, spinner);\n  } catch (e) {\n    await rimraf(entryPoint.destinationPath);\n    throw e;\n  }\n\n  // Removes scripts from package.json after build\n  if (packageJson.scripts) {\n    if (pkg.keepLifecycleScripts !== true) {\n      spinner.info(`Removing scripts section in package.json as it's considered a potential security vulnerability.`);\n      delete packageJson.scripts;\n    } else {\n      spinner.warn(\n        colors.yellow(\n          `You enabled keepLifecycleScripts explicitly. The scripts section in package.json will be published to npm.`,\n        ),\n      );\n    }\n  }\n\n  if (isIvy && !entryPoint.isSecondaryEntryPoint) {\n    const scripts = packageJson.scripts || (packageJson.scripts = {});\n    scripts.prepublishOnly =\n      'node --eval \"console.error(\\'' +\n      'ERROR: Trying to publish a package that has been compiled by Ivy. This is not allowed.\\\\n' +\n      'Please delete and rebuild the package, without compiling with Ivy, before attempting to publish.\\\\n' +\n      '\\')\" ' +\n      '&& exit 1';\n  }\n\n  // keep the dist package.json clean\n  // this will not throw if ngPackage field does not exist\n  delete packageJson.ngPackage;\n\n  const packageJsonPropertiesToDelete = [\n    'stylelint',\n    'prettier',\n    'browserslist',\n    'devDependencies',\n    'jest',\n    'workspaces',\n    'husky',\n  ];\n\n  for (const prop of packageJsonPropertiesToDelete) {\n    if (prop in packageJson) {\n      delete packageJson[prop];\n      spinner.info(`Removing ${prop} section in package.json.`);\n    }\n  }\n\n  packageJson.name = entryPoint.moduleId;\n  await writeFile(path.join(entryPoint.destinationPath, 'package.json'), JSON.stringify(packageJson, undefined, 2));\n}\n\nfunction checkNonPeerDependencies(\n  packageJson: Record<string, unknown>,\n  property: string,\n  allowed: RegExp[],\n  spinner: ora.Ora,\n) {\n  if (!packageJson[property]) {\n    return;\n  }\n\n  for (const dep of Object.keys(packageJson[property])) {\n    if (allowed.some(regex => regex.test(dep))) {\n      log.debug(`Dependency ${dep} is allowed in '${property}'`);\n    } else {\n      spinner.warn(\n        colors.yellow(\n          `Distributing npm packages with '${property}' is not recommended. Please consider adding ${dep} to 'peerDependencies' or remove it from '${property}'.`,\n        ),\n      );\n      throw new Error(`Dependency ${dep} must be explicitly allowed using the \"allowedNonPeerDependencies\" option.`);\n    }\n  }\n}\n"]}